<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บัญชีผู้ใช้</title>
    <link rel="stylesheet" href="../styles/editacct.css">
    <link rel="stylesheet" href="../styles/history.css">
</head>
<body>
    <div class="header">
        <a href="/homepage"><button class="back-button">←</button></a>
    </div> 
    <div class="container">
        <div class="user-info-card">
            <h2 class="title">บัญชีผู้ใช้</h2>

            <div class="info-row">
                <span class="label">ชื่อผู้ใช้</span>
                <span class="value" id="usernameDisplay"><%= username %></span>   <!-- ดึงจาก database -->
                <i class="edit-icon" onclick="openEditPopup('username')">แก้ไข</i>
            </div>

            <div class="info-row">
                <span class="label">ชื่อ-นามสกุล</span>
                <span class="value" id="fullnameDisplay"><%= fname %> <%= sname %></span>   <!-- ดึงจาก database -->
                <i class="edit-icon" onclick="openEditPopup('fullname')">แก้ไข</i>
            </div>

            <div class="info-row">
                <span class="label">รหัสผ่าน</span>
                <span class="value" id="passwordDisplay">********</span>
                <i class="edit-icon" onclick="openEditPopup('password')">แก้ไข</i>
            </div>

            <button class="confirm-btn" onclick="confirmChanges()">ยืนยัน</button>
        </div>
    </div>

    <!-- Pop-up สำหรับแก้ไขข้อมูล -->
    <div class="popup-overlay" id="editPopup">
        <div class="popup-box">
            <h3>แก้ไขข้อมูล</h3>
            <input type="text" id="editInput" placeholder="">
            <div class="popup-buttons">
                <button class="popup-cancel" onclick="closeEditPopup()">ยกเลิก</button>
                <button class="popup-confirm" onclick="saveEdit()">ยืนยัน</button>
            </div>
        </div>
    </div>

    <!-- Pop-up ยืนยันการเปลี่ยนแปลง -->
    <div class="popup-overlay" id="confirmPopup">
        <div class="popup-box">
            <h3>ยืนยันการเปลี่ยนแปลง</h3>
            <p id="summaryText"></p> <br>
            <div class="popup-buttons">
                <button class="popup-cancel" onclick="closeConfirmPopup()">ยกเลิก</button>
                <button class="popup-confirm" onclick="finalConfirm()">ยืนยัน</button>
            </div>
        </div>
    </div>

    <script>
        let currentField = '';      // เก็บว่าแก้ไข field ไหนอยู่
        let tempData = {};          // เก็บค่าชั่วคราวที่แก้ไข

        // เปิด Pop-up ให้กรอกข้อมูลใหม่
        function openEditPopup(field) {
            currentField = field;

            const placeholderMap = {
                username: 'กรอกชื่อผู้ใช้ใหม่',
                fullname: 'กรอกชื่อ-นามสกุลใหม่',
                password: 'กรอกรหัสผ่านใหม่'
            };

            document.getElementById('editInput').placeholder = placeholderMap[field] || '';
            document.getElementById('editInput').value = '';  // เคลียร์ค่าเดิมออก
            document.getElementById('editPopup').classList.add('active');
        }

        // ปิด Pop-up กรอกข้อมูล
        function closeEditPopup() {
            document.getElementById('editPopup').classList.remove('active');
        }

        // บันทึกข้อมูลที่แก้ไข (ยังไม่ยืนยัน)
        function saveEdit() {
            const newValue = document.getElementById('editInput').value;

            if (newValue.trim() === '') {
                alert('กรุณากรอกข้อมูลก่อน');
                return;
            }

            // อัปเดตหน้าจอชั่วคราว + เก็บลง tempData
            if (currentField === 'username') {
                document.getElementById('usernameDisplay').innerText = newValue;
            } else if (currentField === 'email') {
                document.getElementById('emailDisplay').innerText = newValue;
            } else if (currentField === 'password') {
                document.getElementById('passwordDisplay').innerText = '********';  // ซ่อนรหัสผ่าน
            }

            tempData[currentField] = newValue;
            closeEditPopup();
        }

        // เปิด Pop-up ยืนยันการเปลี่ยนแปลง
        function confirmChanges() {
            let summaryText = 'คุณได้ทำการเปลี่ยนแปลงดังนี้:\n';
            let hasChanges = false;

            if (tempData.username) {
                summaryText += `- ชื่อผู้ใช้: ${tempData.username}\n`;
                hasChanges = true;
            }
            if (tempData.email) {
                summaryText += `- อีเมล: ${tempData.email}\n`;
                hasChanges = true;
            }
            if (tempData.password) {
                summaryText += `- รหัสผ่าน: (เปลี่ยนใหม่แล้ว)\n`;
                hasChanges = true;
            }

            if (!hasChanges) {
                alert('คุณยังไม่ได้เปลี่ยนแปลงข้อมูลใดๆ');
                return;
            }

            document.getElementById('summaryText').innerText = summaryText;
            document.getElementById('confirmPopup').classList.add('active');
        }

        // ปิด Pop-up ยืนยันการเปลี่ยนแปลง
        function closeConfirmPopup() {
            document.getElementById('confirmPopup').classList.remove('active');
        }

        // กดปุ่มยืนยันขั้นสุดท้าย (สามารถส่ง tempData ไปเซิร์ฟเวอร์ที่นี่ได้)
        function finalConfirm() {
            console.log('ส่งข้อมูล:', tempData);
            alert('บันทึกข้อมูลเรียบร้อย!');
            document.getElementById('confirmPopup').classList.remove('active');

            // ตรงนี้สามารถใส่ fetch หรือ AJAX ส่ง tempData ไปอัปเดตในฐานข้อมูลได้
            // เช่น fetch('/update-profile', { method: 'POST', body: JSON.stringify(tempData), headers: {'Content-Type': 'application/json'} })

            // เคลียร์ tempData หลังจากยืนยันแล้ว
            tempData = {};
        }
    </script>
</body>
</html>
